<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MapLink Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    :root {
      --bg-light: #e5f3ff;
      --card: #ffffff;
      --accent: #16a34a;
      --accent-soft: #dcfce7;
      --border: #cbd5f5;
      --text-main: #111827;
      --text-sub: #4b5563;
      --radius-xl: 20px;
      --radius-lg: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #eff6ff 40%, #e5f3ff 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }
    .page {
      width: 100%;
      max-width: 980px;
      margin: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    header {
      background: linear-gradient(135deg, #ffffff 0, #f1f5ff 40%, #e0f2fe 100%);
      border-radius: 26px;
      padding: 18px 20px 20px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      box-shadow: 0 10px 30px rgba(148, 163, 184, 0.35);
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #0f172a;
    }
    header h1 span.icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #4ade80 0, #22c55e 40%, #16a34a 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.7), 0 6px 14px rgba(34, 197, 94, 0.5);
      color: #022c22;
    }
    header p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-sub);
    }
    header .badge-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .badge-row .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    main {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    main > section:first-of-type { flex: 3; }
    main > section:last-of-type { flex: 2.2; }

    .card,
    .card-secondary {
      background: var(--card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      padding: 16px 16px 14px;
      box-shadow: 0 8px 24px rgba(148, 163, 184, 0.35);
    }

    .section-header-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
      position: relative;
    }
    .section-title {
      font-size: 0.92rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::before,
    .section-title::after {
      content: "";
      width: 20px;
      height: 1px;
      background: linear-gradient(90deg, rgba(156,163,175,0.7), rgba(209,213,219,0));
    }
    .section-title::after {
      background: linear-gradient(90deg, rgba(209,213,219,0), rgba(156,163,175,0.7));
    }
    .chevron-btn {
      position: absolute;
      right: 0;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #6b7280;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.76rem;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.12s ease, border-color 0.15s ease;
    }
    .chevron-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    .chevron-btn.collapsed { transform: rotate(-90deg); }

    .field { margin-bottom: 10px; }
    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--text-sub);
      text-align: center;
      font-weight: 600;
    }
    label strong { font-weight: 700; }

    input[type="text"],
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
      color: var(--text-main);
      padding: 8px 11px;
      font-size: 0.86rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      min-height: 38px;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
    }
    input[type="text"]:hover,
    textarea:hover {
      border-color: #93c5fd;
      background: #ffffff;
    }
    input[type="text"]:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(22,163,74,0.3);
      background: #ffffff;
    }
    .subtle-hint {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 3px;
    }

    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 13px;
      font-size: 0.84rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.15s ease, opacity 0.1s ease;
    }
    button.primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f0fdf4;
      box-shadow: 0 8px 20px rgba(22,163,74,0.35);
    }
    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(22,163,74,0.45);
    }
    button.secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    button.secondary:hover { background: #e5e7eb; }
    button.danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    button.danger:hover { background: #fecaca; }
    button:disabled { opacity: 0.5; cursor: default; box-shadow: none; }

    .status {
      margin-top: 8px;
      font-size: 0.8rem;
      min-height: 1.2em;
      text-align: center;
    }
    .status.ok { color: #15803d; }
    .status.error { color: #b91c1c; }

    .help-card {
      border-radius: var(--radius-lg);
      border: 1px dashed #d1d5db;
      padding: 9px 11px;
      background: #f9fafb;
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 10px;
    }
    .help-header-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .help-title {
      flex: 1;
      text-align: center;
      font-weight: 700;
    }
    .help-chevron-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #6b7280;
      width: 22px;
      height: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      cursor: pointer;
      padding: 0;
      transition: background 0.15s ease, transform 0.12s ease, border-color 0.15s ease;
    }
    .help-chevron-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    .help-chevron-btn.collapsed { transform: rotate(-90deg); }
    .help-body { margin-top: 6px; }
    .help-card ul {
      margin: 6px 0 0 16px;
      padding: 0;
    }
    .help-card li { margin-bottom: 3px; }

    .route-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      margin-top: 2px;
    }
    .route-select {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 10px;
      background: #f9fafb;
      font-size: 0.8rem;
      color: #374151;
    }

    .route-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .route-card {
      position: relative;
      border-radius: var(--radius-lg);
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 8px 10px 7px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border-left: 4px solid transparent;
      transition: box-shadow 0.15s ease, border-color 0.15s ease, transform 0.08s ease;
    }
    .route-card--naver { border-left-color: #22c55e; }
    .route-card--kakao { border-left-color: #eab308; }
    .route-card.dragging { opacity: 0.7; border-style: dashed; }
    .route-card.drag-over { box-shadow: 0 0 0 2px #60a5fa; }
    .route-card.saved-flash {
      animation: savedPulse 0.6s ease-out;
    }

    .route-top {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      margin-bottom: 2px;
    }
    .route-title-group {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
      text-align: center;
    }
    .route-name-text {
      font-weight: 500;
      font-size: 0.82rem;
      color: #111827;
    }
    .route-color-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #9ca3af;
    }
    .route-color-dot--naver { background: #22c55e; }
    .route-color-dot--kakao { background: #eab308; }

    .route-mini-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: #022c22;
      background: #dcfce7;
      border: 1px solid #bbf7d0;
    }
    .route-mini-icon--kakao {
      background: #fef9c3;
      border-color: #facc15;
      color: #78350f;
    }

    .quick-open-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      width: 22px;
      height: 22px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      transition: background 0.15s ease, box-shadow 0.1s ease, transform 0.08s ease;
    }
    .quick-open-btn:hover {
      background: #eff6ff;
      box-shadow: 0 1px 4px rgba(148, 163, 184, 0.5);
      transform: translateY(-1px);
    }

    .route-chevron {
      position: absolute;
      right: 0;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #6b7280;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.12s ease, border-color 0.15s ease;
    }
    .route-chevron:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    .route-chevron.collapsed { transform: rotate(-90deg); }

    .route-body {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-4px);
      transition: max-height 0.2s ease, opacity 0.18s ease, transform 0.18s ease;
    }
    .route-body.expanded {
      max-height: 500px;
      opacity: 1;
      transform: translateY(0);
    }

    .route-url {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.73rem;
      color: #111827;
      word-break: break-all;
      overflow-wrap: anywhere;
      background: #ffffff;
      border-radius: 10px;
      padding: 6px 9px;
      border: 1px solid #e5e7eb;
      white-space: normal;
      overflow: auto;
    }

    .route-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .route-actions button {
      padding: 4px 9px;
      font-size: 0.74rem;
    }

    .empty {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 4px;
      text-align: center;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.18);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px 14px;
      box-shadow: 0 18px 40px rgba(148, 163, 184, 0.55);
      max-width: 320px;
      width: 90%;
      border: 1px solid #e5e7eb;
    }
    .modal-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
      text-align: center;
      margin-bottom: 6px;
    }
    .modal-message {
      font-size: 0.82rem;
      color: #4b5563;
      text-align: center;
      margin-bottom: 10px;
      white-space: pre-line;
    }
    .modal-input-wrap {
      margin-bottom: 10px;
      display: none;
    }
    .modal-input-wrap input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      padding: 7px 9px;
      font-size: 0.86rem;
      outline: none;
      background: #f9fafb;
    }
    .modal-input-wrap input:focus {
      border-color: #60a5fa;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.2);
    }
    .modal-hint {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 3px;
      text-align: left;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }
    .modal-buttons .primary { padding-inline: 14px; }
    .modal-buttons .secondary { padding-inline: 12px; }

    @keyframes savedPulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.7); }
      100% { box-shadow: 0 0 0 14px rgba(34,197,94,0); }
    }

    /* ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ìµœì í™” */
    @media (max-width: 640px) {
      body {
        justify-content: flex-start;
      }
      .page {
        margin: 12px 10px 20px;
        gap: 12px;
      }
      header {
        padding: 14px 12px 16px;
        border-radius: 18px;
      }
      header h1 {
        font-size: 1.2rem;
        flex-wrap: wrap;
      }
      header h1 span.icon {
        width: 26px;
        height: 26px;
        font-size: 16px;
      }
      header p {
        font-size: 0.82rem;
      }
      .card,
      .card-secondary {
        padding: 12px 10px 10px;
        border-radius: 16px;
        width: 100%;
      }
      main {
        flex-direction: column;
        gap: 12px;
      }
      main > section:first-of-type,
      main > section:last-of-type {
        flex: none;
      }
      .field { margin-bottom: 8px; }
      label { font-size: 0.78rem; }
      input[type="text"],
      textarea {
        font-size: 0.8rem;
        min-height: 36px;
        padding: 7px 9px;
      }
      .button-row {
        flex-direction: column;
        align-items: stretch;
      }
      .button-row button {
        width: 100%;
        justify-content: center;
      }
      .route-toolbar {
        flex-direction: column;
        gap: 6px;
      }
      .route-list {
        max-height: 55vh;
      }
      .route-card {
        padding: 7px 8px 6px;
      }
      .route-name-text {
        font-size: 0.78rem;
      }
      .route-actions {
        justify-content: flex-start;
      }
      .route-actions button {
        flex: 1 1 auto;
        justify-content: center;
      }
      .help-card {
        padding: 8px 9px;
        font-size: 0.78rem;
      }
      .help-card ul {
        margin-left: 14px;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <h1><span class="icon">ğŸ“</span>MapLink Manager</h1>
    <p>ë„¤ì´ë²„ ì§€ë„ Â· ì¹´ì¹´ì˜¤ë§µì—ì„œ ë§Œë“  ê¸¸ì°¾ê¸° URLì„ ì €ì¥í•´ë‘ê³ , í•œ ë²ˆì˜ í´ë¦­ìœ¼ë¡œ ë‹¤ì‹œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <div class="badge-row">
      <div class="badge"><span class="badge-dot"></span>ì¶œë°œì§€Â·ë„ì°©ì§€ê°€ í¬í•¨ëœ URL ê·¸ëŒ€ë¡œ ë³´ê´€</div>
    </div>
  </header>

  <main>
    <!-- ì™¼ìª½: ìƒˆ ê²½ë¡œ ì €ì¥ -->
    <section class="card">
      <div class="section-header-row">
        <div class="section-title">1 Â· ìƒˆ ê²½ë¡œ ì €ì¥</div>
      </div>

      <div class="field">
        <label for="routeName"><strong>ê²½ë¡œ ì´ë¦„</strong></label>
        <input type="text" id="routeName" placeholder="ì˜ˆ: ì§‘ â†’ íšŒì‚¬, ì§‘ â†’ í—¬ìŠ¤ì¥" />
        <p class="subtle-hint">ë‚˜ì¤‘ì— ë¦¬ìŠ¤íŠ¸ì—ì„œ êµ¬ë¶„í•˜ê¸° ì‰¬ìš´ ì´ë¦„ìœ¼ë¡œ ì ì–´ë‘ì„¸ìš”.</p>
      </div>

      <div class="field">
        <label for="routeUrl"><strong>ë„¤ì´ë²„ ì§€ë„ / ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸° URL</strong></label>
        <textarea id="routeUrl" placeholder="ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ì§€ë„ ì•±ì—ì„œ ê¸¸ì°¾ê¸° ì„¤ì • â†’ ê³µìœ  â†’ ë§í¬ ë³µì‚¬ í›„ ì—¬ê¸° ë¶™ì—¬ë„£ê¸°"></textarea>
      </div>

      <div class="button-row">
        <button class="primary" id="saveRouteBtn" type="button">ğŸ’¾ ê²½ë¡œ ì €ì¥</button>
        <button class="secondary" id="clearFormBtn" type="button">ì…ë ¥ ì´ˆê¸°í™”</button>
      </div>

      <div id="status" class="status"></div>

      <div class="help-card">
        <div class="help-header-row">
          <span class="help-title"><strong>ê¸¸ì°¾ê¸° URL ë³µì‚¬ ë°©ë²•</strong></span>
          <button id="helpToggleBtn" class="help-chevron-btn" type="button" aria-label="ë„ì›€ë§ í¼ì¹˜ê¸°/ì ‘ê¸°">â–¾</button>
        </div>
        <div id="helpBody" class="help-body">
          <ul>
            <li>1) ë„¤ì´ë²„ ì§€ë„ ë˜ëŠ” ì¹´ì¹´ì˜¤ë§µì—ì„œ ì¶œë°œì§€Â·ë„ì°©ì§€ë¥¼ ì„¤ì •í•˜ê³  ê¸¸ì°¾ê¸° í™”ë©´ì„ ì—½ë‹ˆë‹¤.</li>
            <li>2) &lt;ê³µìœ &gt; ë˜ëŠ” &lt;ë”ë³´ê¸°&gt; ë©”ë‰´ì—ì„œ â€œë§í¬ ë³µì‚¬â€ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li>
            <li>3) ë³µì‚¬ëœ URLì„ ìœ„ ì¹¸ì— ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ë©´, ì¶œë°œì§€Â·ë„ì°©ì§€ê°€ ê·¸ëŒ€ë¡œ ë“¤ì–´ê°„ ë§í¬ê°€ ë³´ê´€ë©ë‹ˆë‹¤.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½: ì €ì¥ëœ ê²½ë¡œ ëª©ë¡ -->
    <section class="card-secondary">
      <div class="section-header-row">
        <div class="section-title">2 Â· ì €ì¥ëœ ê²½ë¡œ ëª©ë¡</div>
        <button id="toggleListCollapseBtn" class="chevron-btn" type="button" aria-label="ëª©ë¡ í¼ì¹˜ê¸°/ì ‘ê¸°">â–¾</button>
      </div>

      <div class="route-toolbar">
        <select id="serviceFilter" class="route-select">
          <option value="all">ì „ì²´</option>
          <option value="naver">ë„¤ì´ë²„ë§Œ</option>
          <option value="kakao">ì¹´ì¹´ì˜¤ë§Œ</option>
        </select>
        <select id="sortSelect" class="route-select">
          <option value="recent">ìµœê·¼ ì €ì¥ ìˆœ</option>
          <option value="name">ì´ë¦„ ìˆœ</option>
          <option value="service">ì„œë¹„ìŠ¤ ë³„</option>
        </select>
      </div>

      <div id="routeList" class="route-list"></div>
      <div id="emptyState" class="empty">ì¡°ê±´ì— ë§ëŠ” ì €ì¥ëœ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </section>
  </main>
</div>

<!-- ëª¨ë‹¬ -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <div id="modalTitle" class="modal-title"></div>
    <div id="modalMessage" class="modal-message"></div>
    <div id="modalInputWrap" class="modal-input-wrap">
      <input id="modalInput" type="text" />
      <div id="modalHint" class="modal-hint"></div>
    </div>
    <div class="modal-buttons">
      <button id="modalCancel" class="secondary" type="button">ì·¨ì†Œ</button>
      <button id="modalOk" class="primary" type="button">í™•ì¸</button>
    </div>
  </div>
</div>

<script>
(function () {
  const STORAGE_KEY = 'mapRouteSaver.routes.v1';

  const routeNameInput = document.getElementById('routeName');
  const routeUrlInput = document.getElementById('routeUrl');
  const saveRouteBtn = document.getElementById('saveRouteBtn');
  const clearFormBtn = document.getElementById('clearFormBtn');
  const statusEl = document.getElementById('status');

  const helpToggleBtn = document.getElementById('helpToggleBtn');
  const helpBody = document.getElementById('helpBody');

  const routeListEl = document.getElementById('routeList');
  const emptyStateEl = document.getElementById('emptyState');
  const toggleListCollapseBtn = document.getElementById('toggleListCollapseBtn');
  const serviceFilter = document.getElementById('serviceFilter');
  const sortSelect = document.getElementById('sortSelect');

  // Modal elements
  const modalOverlay = document.getElementById('modalOverlay');
  const modalTitle = document.getElementById('modalTitle');
  const modalMessage = document.getElementById('modalMessage');
  const modalInputWrap = document.getElementById('modalInputWrap');
  const modalInput = document.getElementById('modalInput');
  const modalHint = document.getElementById('modalHint');
  const modalCancel = document.getElementById('modalCancel');
  const modalOk = document.getElementById('modalOk');

  let listCollapsed = false;
  let helpCollapsed = false;
  let modalResolve = null;

  let filterService = 'all';
  let sortMode = 'recent';

  function setStatus(message, type) {
    statusEl.textContent = message || '';
    statusEl.classList.remove('ok', 'error');
    if (!message) return;
    statusEl.classList.add(type === 'error' ? 'error' : 'ok');
  }

  function loadRoutes() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed;
    } catch (e) {
      console.error(e);
      return [];
    }
  }

  function saveRoutes(routes) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));
  }

  // ì„œë¹„ìŠ¤ ìë™ ê°ì§€
  function detectServiceFromUrl(url) {
    const u = url.trim().toLowerCase();

    if (u.startsWith('nmap://')) return 'naver';
    if (u.startsWith('kakaomap://')) return 'kakao';

    if (u.includes('map.naver.com') || u.includes('naver.me/')) return 'naver';
    if (u.includes('map.kakao.com') || u.includes('place.map.kakao.com') || u.includes('kko.to/')) return 'kakao';

    return 'raw';
  }

  function updateListVisibility(hasVisible) {
    if (listCollapsed) {
      routeListEl.style.display = 'none';
      emptyStateEl.style.display = 'none';
      toggleListCollapseBtn.classList.add('collapsed');
      toggleListCollapseBtn.textContent = 'â–¸';
    } else {
      routeListEl.style.display = 'flex';
      toggleListCollapseBtn.classList.remove('collapsed');
      toggleListCollapseBtn.textContent = 'â–¾';
      emptyStateEl.style.display = hasVisible ? 'none' : 'block';
    }
  }

  function syncHelpCollapse() {
    if (helpCollapsed) {
      helpBody.style.display = 'none';
      helpToggleBtn.classList.add('collapsed');
      helpToggleBtn.textContent = 'â–¸';
    } else {
      helpBody.style.display = 'block';
      helpToggleBtn.classList.remove('collapsed');
      helpToggleBtn.textContent = 'â–¾';
    }
  }

  helpToggleBtn.addEventListener('click', () => {
    helpCollapsed = !helpCollapsed;
    syncHelpCollapse();
  });
  syncHelpCollapse();

  function closeModal() {
    modalOverlay.style.display = 'none';
    modalInput.value = '';
    modalHint.textContent = '';
    modalInputWrap.style.display = 'none';
    modalResolve = null;
  }

  function openModal(options) {
    const {
      title,
      message,
      showInput = false,
      defaultValue = '',
      placeholder = '',
      hint = '',
      confirmText = 'í™•ì¸',
      cancelText = 'ì·¨ì†Œ',
      mode = 'prompt'
    } = options;

    return new Promise((resolve) => {
      modalResolve = resolve;
      modalTitle.textContent = title || '';
      modalMessage.textContent = message || '';
      modalOk.textContent = confirmText || 'í™•ì¸';
      modalCancel.textContent = cancelText || (mode === 'alert' ? 'ë‹«ê¸°' : 'ì·¨ì†Œ');

      if (mode === 'alert') {
        modalCancel.style.display = 'none';
      } else {
        modalCancel.style.display = 'inline-flex';
      }

      if (showInput) {
        modalInputWrap.style.display = 'block';
        modalInput.value = defaultValue || '';
        modalInput.placeholder = placeholder || '';
        modalHint.textContent = hint || '';
        setTimeout(() => {
          modalInput.focus();
          modalInput.select();
        }, 10);
      } else {
        modalInputWrap.style.display = 'none';
      }

      modalOverlay.style.display = 'flex';
    });
  }

  async function promptValue(options) {
    return await openModal({ ...options, mode: 'prompt', showInput: true });
  }

  async function confirmAction(options) {
    return await openModal({ ...options, mode: 'confirm', showInput: false });
  }

  async function alertMessage(options) {
    await openModal({ ...options, mode: 'alert', showInput: false, cancelText: 'ë‹«ê¸°' });
  }

  modalOk.addEventListener('click', () => {
    if (!modalResolve) return;
    const isInputVisible = modalInputWrap.style.display !== 'none';
    const value = isInputVisible ? modalInput.value : true;
    const resolve = modalResolve;
    closeModal();
    resolve(value);
  });

  modalCancel.addEventListener('click', () => {
    if (!modalResolve) return;
    const resolve = modalResolve;
    closeModal();
    resolve(null);
  });

  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay && modalResolve) {
      const resolve = modalResolve;
      closeModal();
      resolve(null);
    }
  });

  document.addEventListener('keydown', (e) => {
    if (!modalResolve) return;
    if (e.key === 'Escape') {
      const resolve = modalResolve;
      closeModal();
      resolve(null);
    } else if (e.key === 'Enter') {
      const isInputVisible = modalInputWrap.style.display !== 'none';
      if (isInputVisible || e.target === modalOk) {
        const resolve = modalResolve;
        const value = isInputVisible ? modalInput.value : true;
        closeModal();
        resolve(value);
      }
    }
  });

  function getViewItems() {
    const routes = loadRoutes();
    let items = routes.map((route, index) => ({ route, index }));

    if (filterService === 'naver') {
      items = items.filter(x => x.route.service === 'naver');
    } else if (filterService === 'kakao') {
      items = items.filter(x => x.route.service === 'kakao');
    }

    if (sortMode === 'name') {
      items.sort((a, b) => {
        const an = (a.route.name || '').toLowerCase();
        const bn = (b.route.name || '').toLowerCase();
        if (an < bn) return -1;
        if (an > bn) return 1;
        return 0;
      });
    } else if (sortMode === 'service') {
      const rank = { naver: 0, kakao: 1 };
      items.sort((a, b) => {
        const sa = rank[a.route.service] ?? 99;
        const sb = rank[b.route.service] ?? 99;
        if (sa !== sb) return sa - sb;
        const an = (a.route.name || '').toLowerCase();
        const bn = (b.route.name || '').toLowerCase();
        if (an < bn) return -1;
        if (an > bn) return 1;
        return 0;
      });
    } else {
      items.sort((a, b) => (b.route.createdAt || 0) - (a.route.createdAt || 0));
    }

    return items;
  }

  function renderRoutes() {
    const items = getViewItems();
    routeListEl.innerHTML = '';

    const dragEnabled = (filterService === 'all' && sortMode === 'recent');
    const hasVisible = items.length > 0;

    items.forEach(({ route, index }) => {
      const card = document.createElement('div');
      card.className = 'route-card';
      card.dataset.index = index;
      if (route.service === 'naver') card.classList.add('route-card--naver');
      else if (route.service === 'kakao') card.classList.add('route-card--kakao');

      const top = document.createElement('div');
      top.className = 'route-top';

      const titleGroup = document.createElement('div');
      titleGroup.className = 'route-title-group';

      const colorDot = document.createElement('span');
      colorDot.className = 'route-color-dot';
      if (route.service === 'naver') colorDot.classList.add('route-color-dot--naver');
      else if (route.service === 'kakao') colorDot.classList.add('route-color-dot--kakao');

      const miniIcon = document.createElement('span');
      miniIcon.className = 'route-mini-icon';
      miniIcon.textContent = route.service === 'kakao' ? 'K' : 'N';
      if (route.service === 'kakao') miniIcon.classList.add('route-mini-icon--kakao');

      const nameSpan = document.createElement('span');
      nameSpan.className = 'route-name-text';
      nameSpan.textContent = route.name || '(ì œëª© ì—†ìŒ)';

      const quickOpenBtn = document.createElement('button');
      quickOpenBtn.className = 'quick-open-btn';
      quickOpenBtn.type = 'button';
      quickOpenBtn.textContent = 'â†—';
      quickOpenBtn.title = 'ë°”ë¡œ ì—´ê¸°';
      quickOpenBtn.addEventListener('click', () => {
        try { window.open(route.url, '_blank'); } catch (e) { console.error(e); }
      });

      const chevron = document.createElement('button');
      chevron.className = 'route-chevron';
      chevron.type = 'button';
      chevron.textContent = 'â–¾';
      chevron.setAttribute('aria-label', 'ë§í¬ í¼ì¹˜ê¸°/ì ‘ê¸°');

      titleGroup.appendChild(colorDot);
      titleGroup.appendChild(miniIcon);
      titleGroup.appendChild(nameSpan);
      titleGroup.appendChild(quickOpenBtn);

      top.appendChild(titleGroup);
      top.appendChild(chevron);

      const bodyDiv = document.createElement('div');
      bodyDiv.className = 'route-body';

      const urlDiv = document.createElement('div');
      urlDiv.className = 'route-url';
      urlDiv.textContent = route.url;

      const actions = document.createElement('div');
      actions.className = 'route-actions';

      const openBtn = document.createElement('button');
      openBtn.className = 'secondary';
      openBtn.type = 'button';
      openBtn.textContent = 'ì•±ìœ¼ë¡œ ì—´ê¸°';
      openBtn.addEventListener('click', () => {
        try { window.open(route.url, '_blank'); } catch (e) { console.error(e); }
      });

      const copyBtn = document.createElement('button');
      copyBtn.className = 'secondary';
      copyBtn.type = 'button';
      copyBtn.textContent = 'URL ë³µì‚¬';
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(route.url);
          copyBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ';
          setTimeout(() => { copyBtn.textContent = 'URL ë³µì‚¬'; }, 1200);
        } catch (e) {
          console.error(e);
        }
      });

      const editNameBtn = document.createElement('button');
      editNameBtn.className = 'secondary';
      editNameBtn.type = 'button';
      editNameBtn.textContent = 'ì´ë¦„ ìˆ˜ì •';
      editNameBtn.addEventListener('click', async () => {
        const current = loadRoutes();
        const idx = current.findIndex(r => r.id === route.id);
        if (idx === -1) return;
        const newName = await promptValue({
          title: 'ì´ë¦„ ìˆ˜ì •',
          message: 'ì €ì¥ëœ ê²½ë¡œì˜ ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.',
          defaultValue: current[idx].name || '',
          hint: 'ì˜ˆ: ì§‘ â†’ íšŒì‚¬, ì§‘ â†’ í—¬ìŠ¤ì¥'
        });
        if (newName === null) return;
        current[idx].name = String(newName).trim();
        saveRoutes(current);
        renderRoutes();
      });

      const editUrlBtn = document.createElement('button');
      editUrlBtn.className = 'secondary';
      editUrlBtn.type = 'button';
      editUrlBtn.textContent = 'ë§í¬ ìˆ˜ì •';
      editUrlBtn.addEventListener('click', async () => {
        const current = loadRoutes();
        const idx = current.findIndex(r => r.id === route.id);
        if (idx === -1) return;
        const newUrl = await promptValue({
          title: 'ë§í¬ ìˆ˜ì •',
          message: 'ìƒˆ ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ì§€ë„ URLì„ ì…ë ¥í•˜ì„¸ìš”.',
          defaultValue: current[idx].url || '',
          hint: 'ì§€ë„ ì•±ì—ì„œ ë‹¤ì‹œ ê³µìœ  â†’ ë§í¬ ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸°'
        });
        if (newUrl === null) return;
        const trimmed = String(newUrl).trim();
        if (!trimmed) {
          await alertMessage({ title: 'ì…ë ¥ ì˜¤ë¥˜', message: 'URLì´ ë¹„ì–´ ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
          return;
        }
        const svc = detectServiceFromUrl(trimmed);
        if (svc === 'raw') {
          await alertMessage({
            title: 'URL ì˜¤ë¥˜',
            message: 'ë„¤ì´ë²„ ì§€ë„ / ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸° URLë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
          });
          return;
        }
        current[idx].url = trimmed.replace(/\s+/g, ' ').trim();
        current[idx].service = svc;
        saveRoutes(current);
        renderRoutes();
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'danger';
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'ì‚­ì œ';
      deleteBtn.addEventListener('click', async () => {
        const ok = await confirmAction({
          title: 'ê²½ë¡œ ì‚­ì œ',
          message: 'ì´ ê²½ë¡œë¥¼ ì •ë§ ì‚­ì œí• ê¹Œìš”?\nì‚­ì œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
        });
        if (!ok) return;
        const current = loadRoutes();
        const filtered = current.filter(r => r.id !== route.id);
        saveRoutes(filtered);
        renderRoutes();
      });

      actions.appendChild(openBtn);
      actions.appendChild(copyBtn);
      actions.appendChild(editNameBtn);
      actions.appendChild(editUrlBtn);
      actions.appendChild(deleteBtn);

      bodyDiv.appendChild(urlDiv);
      bodyDiv.appendChild(actions);

      let collapsed = true;
      function syncRouteCollapse() {
        if (collapsed) {
          bodyDiv.classList.remove('expanded');
          chevron.classList.add('collapsed');
          chevron.textContent = 'â–¸';
        } else {
          bodyDiv.classList.add('expanded');
          chevron.classList.remove('collapsed');
          chevron.textContent = 'â–¾';
        }
      }
      chevron.addEventListener('click', () => {
        collapsed = !collapsed;
        syncRouteCollapse();
      });
      syncRouteCollapse();

      if (dragEnabled) {
        card.draggable = true;

        card.addEventListener('dragstart', () => {
          card.classList.add('dragging');
        });

        card.addEventListener('dragend', () => {
          card.classList.remove('dragging');
        });

        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          card.classList.add('drag-over');
        });

        card.addEventListener('dragleave', () => {
          card.classList.remove('drag-over');
        });

        card.addEventListener('drop', (e) => {
          e.preventDefault();
          card.classList.remove('drag-over');

          const dragging = routeListEl.querySelector('.route-card.dragging');
          if (!dragging) return;
          const fromIndex = parseInt(dragging.dataset.index, 10);
          const toIndex = parseInt(card.dataset.index, 10);
          if (isNaN(fromIndex) || isNaN(toIndex) || fromIndex === toIndex) return;

          const current = loadRoutes();
          const [moved] = current.splice(fromIndex, 1);
          current.splice(toIndex, 0, moved);
          saveRoutes(current);
          renderRoutes();
        });
      }

      card.appendChild(top);
      card.appendChild(bodyDiv);

      routeListEl.appendChild(card);
    });

    updateListVisibility(hasVisible);
  }

  function clearForm() {
    routeNameInput.value = '';
    routeUrlInput.value = '';
    setStatus('', null);
  }

  saveRouteBtn.addEventListener('click', () => {
    const name = routeNameInput.value.trim();
    let url = routeUrlInput.value.trim();

    if (!url) {
      setStatus('ê¸¸ì°¾ê¸° URLì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.', 'error');
      return;
    }

    url = url.replace(/\s+/g, ' ').trim();

    const svc = detectServiceFromUrl(url);
    if (svc === 'raw') {
      setStatus('ë„¤ì´ë²„ ì§€ë„ / ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸° URLë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
      return;
    }

    const routes = loadRoutes();
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2, 8);

    routes.push({
      id,
      name: name || '',
      url,
      service: svc,
      createdAt: Date.now()
    });

    saveRoutes(routes);
    renderRoutes();
    clearForm();
    setStatus('ê²½ë¡œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');

    const cards = routeListEl.querySelectorAll('.route-card');
    if (cards.length > 0) {
      const last = cards[cards.length - 1];
      last.classList.add('saved-flash');
      routeListEl.scrollTop = routeListEl.scrollHeight;
      setTimeout(() => last.classList.remove('saved-flash'), 700);
    }
  });

  clearFormBtn.addEventListener('click', clearForm);

  toggleListCollapseBtn.addEventListener('click', () => {
    listCollapsed = !listCollapsed;
    const items = getViewItems();
    updateListVisibility(items.length > 0);
  });

  serviceFilter.addEventListener('change', () => {
    filterService = serviceFilter.value;
    renderRoutes();
  });

  sortSelect.addEventListener('change', () => {
    sortMode = sortSelect.value;
    renderRoutes();
  });

  renderRoutes();
})();
</script>
</body>
</html>
